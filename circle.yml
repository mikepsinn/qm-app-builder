# Customize the test machine
machine:
  node:
    version: 6.10.3
  ruby:
    version: 2.1.2
  java:
    version: oraclejdk8
  environment:
    _JAVA_OPTIONS: "-Xms512m -Xmx1024m" # Appears to solve "Your build has exceeded the memory limit of 4G on 1 container"
    GRADLE_OPTS: '-Dorg.gradle.jvmargs="-Xmx2048m -XX:+HeapDumpOnOutOfMemoryError"'  # Did not solve "Your build has exceeded the memory limit of 4G on 1 container"

checkout:
  post:
    - git submodule sync --recursive
    - git submodule update --recursive --init # use submodules
    - apt-get install tree
    - tree
    - chmod -R +x ./app/scripts

# Customize dependencies
dependencies:
  post:
    #- wget https://saucelabs.com/downloads/sc-latest-linux.tar.gz
    #- tar -xzf sc-latest-linux.tar.gz
  pre:
    - git fetch --all --unshallow || true
    - chmod +x -R ./app/hooks/*
    - chmod 777 -R $PWD

  override:
    - echo "This line is to prevent automatic dependency installation."

  cache_directories:
    - "./app/node_modules"   # Probably don't want to cache node_modules so we catch problematic dependency changes

test:
  override:
    - echo "This line is to prevent automatic test detection."

general:
  branches:
    ignore:
      - gh-pages # list of branches to ignore
      - /release\/.*/ # or ignore regexes
  artifacts:
    - "./app/build"
    #- "./app/dropbox"

deployment:
  apps:
    branch: /apps\/.*/
    commands:
      - ./app/scripts/circleci_install_dependencies.sh
      - cd app && gulp prepareRepositoryForAndroid
      - cd app && gulp buildAndroidApp
      - cd app && gulp buildChromeExtension
  staging:
    branch: develop
    commands:
      - ./app/scripts/circleci_install_dependencies.sh
      - ./app/scripts/circleci_build_android_apps_and_chrome_extensions.sh
      - bash buddybuild_postbuild.sh
  production:
    branch: master
    commands:
      - ./app/scripts/circleci_install_dependencies.sh
      - ./app/scripts/circleci_build_android_apps_and_chrome_extensions.sh
      - cd app && gulp ionicUploadProductionForAllApps