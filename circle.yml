# Customize the test machine
machine:
  node:
    version: 6.10.3
  java:
    version: oraclejdk8
  environment:
    _JAVA_OPTIONS: "-Xms512m -Xmx1024m" # Appears to solve "Your build has exceeded the memory limit of 4G on 1 container"
    GRADLE_OPTS: '-Dorg.gradle.jvmargs="-Xmx2048m -XX:+HeapDumpOnOutOfMemoryError"'  # Did not solve "Your build has exceeded the memory limit of 4G on 1 container"

checkout:
  post:
    - git submodule sync --recursive
    - git submodule update --recursive --init # use submodules

# Customize dependencies
dependencies:
  pre:
    - sudo apt-get update; sudo apt-get install tree imagemagick
    - git fetch --all --unshallow
    - chmod 777 -R $PWD
    - npm install -g gulp cordova@7.0.0 ionic@2.2.3 bower
  post:
    - tree
    - chmod -R +x ./app/scripts
    - chmod +x -R ./app/hooks/*
    - cd app && npm install
    - cd app && ionic info

  override:
    - echo "This line is to prevent automatic dependency installation."

  cache_directories:
    - /home/ubuntu/nvm/versions/node/<version>/bin
    - /home/ubuntu/nvm/versions/node/<version>/lib/node_modules
    - app/node_modules   # Probably don't want to cache node_modules so we catch problematic dependency changes

test:
  override:
    - echo "This line is to prevent automatic test detection."

general:
  branches:
    ignore:
      - gh-pages # list of branches to ignore
      - /release\/.*/ # or ignore regexes
  artifacts:
    - "./app/build"
    #- "./app/dropbox"

deployment:
  apps:
    branch: /apps\/.*/
    commands:
      - cd app && gulp prepareRepositoryForAndroid
      - cd app && gulp buildAndroidApp
      - cd app && gulp buildChromeExtension
  staging:
    branch: develop
    commands:
      - ./app/scripts/circleci_build_android_apps_and_chrome_extensions.sh
      - bash buddybuild_postbuild.sh
  production:
    branch: master
    commands:
      - ./app/scripts/circleci_build_android_apps_and_chrome_extensions.sh
      - cd app && gulp ionicUploadProductionForAllApps